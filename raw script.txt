Функция ОтрезатьОписаниеОтДатыДоговора(ДатаДоговора)      
	ИндексСкобки = Найти(ДатаДоговора, "(");
	Если ИндексСкобки <> 0 Тогда
		СтрокаДоСимволаРазделителя = Лев(ДатаДоговора, ИндексСкобки - 1);  
		Возврат СтрокаДоСимволаРазделителя;
	Иначе
		Возврат ДатаДоговора;
	КонецЕсли;
КонецФункции
            
Функция ОтрезатьОписание(Договор)      
	ИндексСкобки = Найти(Договор, "(");
	Если ИндексСкобки <> 0 Тогда
		СтрокаДоСимволаРазделителя = Лев(Договор, ИндексСкобки - 2);  
		Возврат СтрокаДоСимволаРазделителя;
	Иначе    
		ИндексГода = Найти(Договор, "г.");
		
		Возврат Лев(Договор, ИндексГода);
	КонецЕсли;
КонецФункции

Процедура НайтиКонтрагентаПоКоду(КодКонтрагента)
    Справочник = СоздатьОбъект("Справочник.Контрагенты"); 
    Если Справочник.НайтиПоКоду(КодКонтрагента, 1)=1 Тогда
        Сообщить(Справочник.Наименование);
    Иначе
        Сообщить("-");
    КонецЕсли;

КонецПроцедуры //НайтиКонтрагентаПоКоду 


Процедура НайтиДоговорПоКоду(КодДоговора)
    Справочник = СоздатьОбъект("Справочник.Договоры"); 
    Если Справочник.НайтиПоКоду(КодДоговора, 0)=1 Тогда
        Сообщить(Справочник.Наименование);
    Иначе
        Сообщить("-");
    КонецЕсли;   

КонецПроцедуры //НайтиДоговорПоКоду


Функция ПолучитьВалютуДоговора(Договор, ПолныйДоговор)  
	Справочник = СоздатьОбъект("Справочник.Договоры"); 
	ИндексЗак = Найти(Договор, "Зак");
	ИндексЗаказ = Найти(Договор, "зак");
	
	Если ((ИндексЗак > 0) И (ИндексЗаказ > 0)) Тогда 
	    Договор = ОтрезатьОписаниеОтДатыДоговора(Договор);
	КонецЕсли;
	
    Если Справочник.НайтиПоНаименованию(Договор, 0, 0)=1 Тогда  
		Индекс = Найти(ПолныйДоговор, ОтрезатьОписание(Справочник.Наименование));
		Если Индекс > 0 Тогда 
			Если ПустоеЗначение(Справочник.ВалютаДоговора) = 1 Тогда           
			    Возврат("руб");
			Иначе
				Возврат(Справочник.ВалютаДоговора);
			КонецЕсли;
		Иначе       
        	Возврат("-");
		КонецЕсли;
	КонецЕсли;
КонецФункции //ПолучитьВалютуДоговора


Функция РегулярноеВыражение(ВходнаяСтрока)      
	Истина = -1;
	Ложь = 0;
	RegExp = CreateObject("VBScript.RegExp");
	RegExp.IgnoreCase = Ложь;
 	RegExp.Global = Истина;
 	RegExp.MultiLine = Ложь;  
 	RegExp.Pattern = "\d{2}.\d{2}.(\d{4}|\d{2}( |г))";
 	Matches=RegExp.Execute(ВходнаяСтрока);
 	Для С = 0 По Matches.Count()-1 Цикл
 		Match = Matches.Item(С);   
 		Если ПустаяСтрока(Match.Value) = 0 Тогда
 		    // Сообщить(Match.Value);
 			 Возврат 1;
 		КонецЕсли;
 	КонецЦикла; 	
КонецФункции //РегулярноеВыражение
 

Функция РазложитьОписаниеВМассив(Знач Стр, Разделитель = " ") Экспорт
	СЗ = СоздатьОбъект("СписокЗначений");
	Если Разделитель = " " Тогда
		Стр = СокрЛП(Стр);
		Пока 1=1 Цикл
			Поз = Найти(Стр,Разделитель);
			Если Поз=0 Тогда
				СЗ.ДобавитьЗначение(Стр);
				Возврат СЗ;
			КонецЕсли;
			СЗ.ДобавитьЗначение(Лев(Стр,Поз-1));
			Стр = СокрЛ(Сред(Стр,Поз));
		КонецЦикла;
	Иначе
		ДлинаРазделителя = СтрДлина(Разделитель);
		Пока 1=1 Цикл
			Поз = Найти(Стр,Разделитель);
			Если Поз=0 Тогда
				СЗ.ДобавитьЗначение(Стр);
				Возврат СЗ;
			КонецЕсли;
			СЗ.ДобавитьЗначение(Лев(Стр,Поз-1));
			Стр = Сред(Стр,Поз+ДлинаРазделителя);
		КонецЦикла;
	КонецЕсли;
КонецФункции   


Функция ПолучитьДатуДоговора(ДоговорВСтроке)
		Для Индекс = 3 По ДоговорВСтроке.РазмерСписка() Цикл    
			Если РегулярноеВыражение(ДоговорВСтроке.получитьЗначение(Индекс)) = 1 Тогда
				Возврат ДоговорВСтроке.получитьЗначение(Индекс); 
			КонецЕсли;
		КонецЦикла;
КонецФункции    
	
Функция НайтиАвансВОписании(Описание, Аванс)
	Позиция = Найти(Описание, Аванс);
	Если Позиция = 0 Тогда
	    Возврат "-";
	Иначе
		Возврат "+";
	КонецЕсли;
КонецФункции    

Функция НайтиПроцентАванса(СтрокаАванс)
	Позиция = Найти(СтрокаАванс, "%");
	Если Позиция = 0 Тогда
	    Возврат "+";
	Иначе      
		СтрокаАванс = Лев(СтрокаАванс, Позиция);
		Возврат Сред(СтрокаАванс, Позиция-2);
	КонецЕсли;
КонецФункции


Процедура Сформировать_Колонки(Ит, Таб, Стр)
	Таб.ВывестиСекцию(Стр);
КонецПроцедуры       


Функция ПолучениеНомераДоговора(Договор)
	ПозицияЗаказаБР = Найти(Договор, "Зак");
	ПозицияЗаказаМР = Найти(Договор, "зак");
	Если ((ПозицияЗаказаБР = 0) И (ПозицияЗаказаМР = 0)) Тогда
	    ПозицияОт = Найти(Договор, "от");
		СтрокаДоСимволаРазделителя = Лев(Договор, ПозицияОт - 1);  
		Возврат СтрокаДоСимволаРазделителя;
	Иначе 
		Возврат Договор;
	КонецЕсли;	
КонецФункции    


Функция ПолучитьКороткоеОписание(ПолныйДоговор)
	Индекс = Найти(ПолныйДоговор, "(");
	Если Индекс = 0 Тогда
	    Возврат "-";
	Иначе
		Возврат Сред(ПолныйДоговор, Индекс);
	КонецЕсли;
	
КонецФункции     


Функция ПолучитьЗачтенныйАванс(АвансОписание)    
	Индекс = Найти(АвансОписание, "ачтена предоплата");
	Если Индекс = 0 Тогда
	    Возврат "-";
	Иначе
		Возврат "+";
	КонецЕсли;
КонецФункции
               

Процедура Сформировать()
	Таб = СоздатьОбъект("Таблица");
	Таб.ИсходнаяТаблица("Таблица");  
	
	Ит = СоздатьОбъект("БухгалтерскиеИтоги");
	Ит.ИспользоватьСубконто(ВидыСубконто.Контрагенты,, 1);
	Ит.ИспользоватьСубконто(ВидыСубконто.Договоры,, 1);
	Ит.ВыполнитьЗапрос(ВыбНачПериода, ВыбКонПериода, "62",,, 1, "Проводка", "СК"); 
	
	Сформировать_Колонки(Ит, Таб, "Шапка");                                                                                             
	Таб.Опции(0,0,Таб.ВысотаТаблицы(),0);   
	
	Ит2 = СоздатьОбъект("БухгалтерскиеИтоги"); 
	НомерСтроки = 0;
	
	Ит.ВыбратьСубконто(ВидыСубконто.Договоры);
	Пока Ит.ПолучитьСубконто(ВидыСубконто.Договоры) = 1 Цикл
		ВыбСубконто1 = (Ит.Субконто(ВидыСубконто.Контрагенты)); 
		ВыбСубконто2 = (Ит.Субконто(ВидыСубконто.Договоры));
		Ит2.ИспользоватьСубконто(ВидыСубконто.Контрагенты, ВыбСубконто1, 2); 
		Ит2.ИспользоватьСубконто(ВидыСубконто.Договоры, ВыбСубконто2, 2);
		Ит2.ВыполнитьЗапрос(ВыбНачПериода, ВыбКонПериода, "62",,, 1, "Проводка", "СК");  
		
		
		//определяем все переменные
	//	    Дт = Ит.ВыбранаПоДт();
	//		Кт = Ит.ВыбранаПоКт();
	//		Опер = Ит2.Операция;   
	//		Сд = Ит.СКД() - Ит.СКК(); 
	//		ДоговорВСтроке
	//	    ДатаДоговора
	//		Аванс
	//		НомерДоговора
	//		ВсегоРублей
		
		//Продолжаем работу
		Контрагент_Таблица = Ит.Субконто(ВидыСубконто.Контрагенты);
		Договор_Таблица    = Ит.Субконто(ВидыСубконто.Договоры); 
		Опер = ""; 
		ДоговорВСтроке = РазложитьОписаниеВМассив(Договор_Таблица," "); 
		ДатаДоговора = ПолучитьДатуДоговора(ДоговорВСтроке);   
		ДатаДоговора = ОтрезатьОписаниеОтДатыДоговора(ДатаДоговора); 
		НомерДоговора = ПолучениеНомераДоговора(Договор_Таблица); 
		НомерСтроки = НомерСтроки + 1;
		Валюта = ПолучитьВалютуДоговора(ОтрезатьОписание(Договор_Таблица), Договор_Таблица);   
//	Валюта = ПолучитьВалютуДоговора(Договор_Таблица, Договор_Таблица);  
		Описание = "-"; 
		Аванс = "-"; 
		Аванс_Таблица = "-";
		СуммаАванса = 0;
		ЗачтенаПредоплата = "-";
		ЗачтенаПредоплата_Таблица = "-";
		СуммаПредоплаты = 0;       
		
		ВсегоРуб = 0;
		НеВсегоРуб = 0;
	
		
		Ит2.ВыбратьПериоды();
		Пока Ит2.ПолучитьПериод() = 1 Цикл
			Дт = Ит.ВыбранаПоДт();
			Кт = Ит.ВыбранаПоКт();
			Опер = Ит2.Операция;      
			Описание = Опер.ПредставлениеПроводки(1);    
			Сд = Ит.СКД() - Ит.СКК();
			Если Описание<>"-" Тогда  
				ОписаниеОтр = Лев(Описание, 50);
				Аванс = НайтиАвансВОписании(ОписаниеОтр, "Аванс"); 
				Если Аванс <> "-" Тогда
			    	Аванс_Таблица = Аванс;
				КонецЕсли;  
			
				ЗачтенаПредоплата = ПолучитьЗачтенныйАванс(ОписаниеОтр);                                                     //50
				Если ЗачтенаПредоплата <> "-" Тогда
			    	ЗачтенаПредоплата_Таблица = ЗачтенаПредоплата;
				КонецЕсли; 
				Если Аванс = "+" Тогда  
					Аванс_Таблица=НайтиПроцентАванса(ОписаниеОтр);
					СуммаАванса = СуммаАванса + Опер.Сумма;
				КонецЕсли; 
				Если ЗачтенаПредоплата = "+" Тогда  
					СуммаПредоплаты = СуммаПредоплаты + Опер.Сумма;
				КонецЕсли;  
			КонецЕсли;
			
				
			
			Если ((Ит2.СКК() = 0) И (Ит2.СКД() = 0)) Тогда 
				ВсегоРуб = Ит2.ДО() + Ит2.КО();
				НеВсегоРуб = ВсегоРуб;
			Иначе
				ВсегоРуб = 0;
				НеВсегоРуб = НеВсегоРуб + Опер.Сумма;
			КонецЕсли;
			
			
			Ин = Найти(Контрагент_Таблица, "КДМС");
			Если Ин <> 0 Тогда
			    Сообщить(НеВсегоРуб);
			КонецЕсли;               
			
			
		КонецЦикла;  
	    Если Описание = "-" Тогда
	        Описание = ПолучитьКороткоеОписание(Договор_Таблица);
	    КонецЕсли;

		Таб.ВывестиСекцию("Субконто1");;
	КонецЦикла;              
                                         
	Таб.ВывестиСекцию ("Подвал"); 
	Таб.ТолькоПросмотр(1);
	Таб.Показать("Сформировать","");
КонецПроцедуры                    

//}}БУХГАЛТЕРСКИЙ ЗАПРОС  

Процедура ПриОткрытии()

//{{ИНИЦИАЛИЗАЦИЯ БУХГАЛТЕРСКОГО ЗАПРОСА(Сформировать)
	ВыбНачПериода = НачалоПериодаБИ();
	ВыбКонПериода = КонецПериодаБИ();
//{{ИНИЦИАЛИЗАЦИЯ БУХГАЛТЕРСКОГО ЗАПРОСА

КонецПроцедуры